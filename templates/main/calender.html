{% extends 'base.html' %}
{% block title %}Kalender{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">ğŸ“… Fahrstunden-Kalender</h1>

<div class="flex flex-wrap gap-2 mb-4">
    <button class="view-toggle bg-blue-600 text-white px-3 py-1 rounded" data-view="day">ğŸ“… Tag</button>
    <button class="view-toggle bg-blue-600 text-white px-3 py-1 rounded" data-view="week">ğŸ—“ï¸ Woche</button>
    <button class="view-toggle bg-blue-600 text-white px-3 py-1 rounded" data-view="month">ğŸ“† Monat</button>
    <button id="prev" class="bg-gray-400 text-white px-3 py-1 rounded">â®ï¸ ZurÃ¼ck</button>
    <button id="next" class="bg-gray-400 text-white px-3 py-1 rounded">â­ï¸ Weiter</button>
    <button id="today" class="bg-green-600 text-white px-3 py-1 rounded">ğŸ“Œ Heute</button>
</div>

<div id="calendar-container" class="overflow-x-auto"></div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let currentView = "week";
    let today = new Date();

    function formatDate(date) {
        return date.toISOString().split("T")[0];
    }

    function formatGermanDate(dateStr) {
        const [y, m, d] = dateStr.split("-");
        return `${d}.${m}.${y}`;
    }

    function generateDates(view) {
        let dates = [];
        if (view === "day") {
            dates.push(formatDate(today));
        } else if (view === "week") {
            let start = new Date(today);
            start.setDate(start.getDate() - (start.getDay() + 6) % 7); // Montag
            for (let i = 0; i < 7; i++) {
                let d = new Date(start);
                d.setDate(start.getDate() + i);
                dates.push(formatDate(d));
            }
        } else if (view === "month") {
            let y = today.getFullYear();
            let m = today.getMonth();
            let d = new Date(y, m, 1);
            while (d.getMonth() === m) {
                dates.push(formatDate(new Date(d)));
                d.setDate(d.getDate() + 1);
            }
        }
        return dates;
    }

    function renderCalendar(view) {
        const container = document.getElementById("calendar-container");
        container.innerHTML = "";

        const dates = generateDates(view);
        let table = document.createElement("table");
        table.className = "table-auto min-w-full bg-white rounded shadow";

        let thead = document.createElement("thead");
        thead.innerHTML = `
            <tr class="bg-gray-100">
                <th class="px-4 py-2">Datum</th>
                <th class="px-4 py-2">Zeit</th>
                <th class="px-4 py-2">Fahrlehrer</th>
                <th class="px-4 py-2">Simulator</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Aktion</th>
            </tr>`;
        table.appendChild(thead);

        let tbody = document.createElement("tbody");
        table.appendChild(tbody);
        container.appendChild(table);

        dates.forEach(date => {
            fetch(`/calendar/slots?date=${date}`)
                .then(response => response.json())
                .then(slots => {
                    if (slots.length === 0) {
                        let row = document.createElement("tr");
                        row.innerHTML = `
                            <td class="px-4 py-2">${formatGermanDate(date)}</td>
                            <td class="px-4 py-2 text-gray-400" colspan="5">Keine Slots</td>`;
                        tbody.appendChild(row);
                    } else {
                        slots.forEach(slot => {
                            let row = document.createElement("tr");
                            row.innerHTML = `
                                <td class="px-4 py-2">${formatGermanDate(slot.date)}</td>
                                <td class="px-4 py-2">${slot.time}</td>
                                <td class="px-4 py-2">${slot.fahrlehrer || '-'}</td>
                                <td class="px-4 py-2">${slot.simulator ? 'ğŸ–¥ï¸' : '-'}</td>
                                <td class="px-4 py-2">${slot.status}</td>
                                <td class="px-4 py-2">
                                    ${slot.status === "frei" ? `<button class="bg-blue-600 text-white px-2 py-1 rounded book-btn" data-id="${slot.id}">Buchen</button>` : `<span class="text-gray-400">Nicht buchbar</span>`}
                                </td>`;
                            tbody.appendChild(row);
                        });
                        attachBookHandlers();
                    }
                });
        });
    }

    function attachBookHandlers() {
        document.querySelectorAll(".book-btn").forEach(button => {
            button.addEventListener("click", function() {
                const slotId = this.getAttribute("data-id");
                fetch("/calendar/book", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ slot_id: slotId })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    renderCalendar(currentView);
                });
            });
        });
    }

    document.querySelectorAll(".view-toggle").forEach(btn => {
        btn.addEventListener("click", function() {
            currentView = this.getAttribute("data-view");
            renderCalendar(currentView);
        });
    });

    document.getElementById("prev").addEventListener("click", function() {
        if (currentView === "day") {
            today.setDate(today.getDate() - 1);
        } else if (currentView === "week") {
            today.setDate(today.getDate() - 7);
        } else {
            today.setMonth(today.getMonth() - 1);
        }
        renderCalendar(currentView);
    });

    document.getElementById("next").addEventListener("click", function() {
        if (currentView === "day") {
            today.setDate(today.getDate() + 1);
        } else if (currentView === "week") {
            today.setDate(today.getDate() + 7);
        } else {
            today.setMonth(today.getMonth() + 1);
        }
        renderCalendar(currentView);
    });

    document.getElementById("today").addEventListener("click", function() {
        today = new Date();
        renderCalendar(currentView);
    });

    renderCalendar(currentView);
});
</script>
{% endblock %}
